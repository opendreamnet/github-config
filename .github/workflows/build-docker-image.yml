on:
  workflow_call:
    inputs:
      # Target environment name used for build-time configuration.
      environment:
        type: string
        required: true
      # Controls whether the Docker image is pushed to the registry.
      docker-push:
        type: boolean
        default: ${{ github.event_name != 'pull_request' }}
      # Docker image name and registry path used for tagging.
      docker-image-name:
        type: string
        required: false
        default: ghcr.io/${{ github.repository }}
      # Dockerfile path used during the build.
      docker-file:
        type: string
        required: false
        default: ./Dockerfile
      # Target platforms for multi-arch Docker builds.
      docker-platforms:
        type: string
        required: false
        default: linux/amd64
      # Additional build arguments forwarded to Docker.
      docker-build-args:
        required: false
        type: string
      # BuildKit secrets keys to pass to Docker build.
      docker-build-secret-keys:
        required: false
        type: string
        default: "[]"
      # Disables Docker layer caching when set to true.
      docker-no-cache:
        type: boolean
        default: false
      # Cache export mode used for the Docker registry cache.
      docker-cache-mode:
        type: string
        default: max
      # Cache mode used for the GitHub Actions cache backend.
      docker-gha-cache-mode:
        type: string
        default: min
      # Tag templates used by docker/metadata-action.
      docker-metadata-tags:
        type: string
        default: |
          type=schedule
          type=edge
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern=v{{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
      # Working directory passed to Docker build context.
      working-directory:
        type: string
        required: false
        default: "."
      # Optional deploy webhook URL called after a successful build.
      deploy-url:
        required: false
        type: string
      # GitHub Actions runner label used for the job.
      runs-on:
        type: string
        default: '"ubuntu-latest"'

jobs:
  build:
    name: build
    runs-on: ${{ fromJSON(inputs.runs-on) }}
    environment: ${{ inputs.environment }}

    env:
      GIT_SHA: ${{ github.sha }}
      GIT_SHORT_SHA: ${{ github.sha }}

      # Linting
      CF_ACCESS_CLIENT_ID: ${{ vars.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ vars.CF_ACCESS_CLIENT_SECRET }}
      SENTRY_AUTH_TOKEN: ${{ vars.SENTRY_AUTH_TOKEN }}

    steps:
      - name: üíª Set Environment Variables
        run: |
          echo "GIT_SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_ENV

      - name: üìÅ Checkout
        uses: actions/checkout@v6

      - name: üîí Login to GitHub Container Registry
        uses: docker/login-action@v3
        if: ${{ inputs.docker-push == true }}
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚öôÔ∏è Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: üê¨ Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Load 1Password Secrets
        uses: 1password/load-secrets-action@v3
        continue-on-error: true
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: üîê Prepare BuildKit secrets
        id: buildkit-secrets
        run: |
          secrets_json='${{ toJSON(secrets) }}'
          requested='${{ inputs.docker-build-secret-keys }}'
          if [ -z "$requested" ]; then
            echo "value=" >> $GITHUB_OUTPUT
            exit 0
          fi
          secrets_list=$(echo "$requested" | jq -r '.[]' 2>/dev/null || true)
          if [ -z "$secrets_list" ]; then
            echo "value=" >> $GITHUB_OUTPUT
            exit 0
          fi
          buildkit_secrets=""
          for key in $secrets_list; do
            secret_value=$(echo "$secrets_json" | jq -r --arg key "$key" '.[$key] // empty')
            if [ -z "$secret_value" ]; then
              echo "Missing secret: $key" >&2
              exit 1
            fi
            buildkit_secrets="${buildkit_secrets}${key}=${secret_value}"$'\n'
          done
          echo "value<<EOF" >> $GITHUB_OUTPUT
          echo "$buildkit_secrets" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "$buildkit_secrets"

      - name: üê¨ Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.docker-image-name }}
          tags: ${{ inputs.docker-metadata-tags }}

      - name: üèóÔ∏è Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.working-directory }}
          push: ${{ inputs.docker-push }}
          file: ${{ inputs.docker-file }}
          platforms: ${{ inputs.docker-platforms }}
          no-cache: ${{ inputs.docker-no-cache }}
          cache-from: |
            type=registry,ref=${{ inputs.docker-image-name }}:cache-${{ fromJSON(steps.meta.outputs.json).tag-names[0] }}
          cache-to: |
            type=registry,ref=${{ inputs.docker-image-name }}:cache-${{ fromJSON(steps.meta.outputs.json).tag-names[0] }},mode=${{ inputs.docker-cache-mode }},compression=zstd
          build-args: |
            NODE_ENV=${{ inputs.environment }}
            GIT_SHA=${{ env.GIT_SHA }}
            GIT_SHORT_SHA=${{ env.GIT_SHORT_SHA }}
            SENTRY_AUTH_TOKEN=${{ env.SENTRY_AUTH_TOKEN }}
            ${{ inputs.docker-build-args }}
          secrets: ${{ steps.buildkit-secrets.outputs.value }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}

      - name: üéá Deploy
        uses: fjogeleit/http-request-action@v2
        if: ${{ inputs.deploy-url != '' && inputs.deploy-url != null }}
        continue-on-error: true
        with:
          url: ${{ inputs.deploy-url }}
          method: POST
          customHeaders: '{ "CF-Access-Client-Id": "${{ env.CF_ACCESS_CLIENT_ID }}", "CF-Access-Client-Secret": "${{ env.CF_ACCESS_CLIENT_SECRET }}" }'
          timeout: 60000
